# 项目设计与构建经验

本文档整理本仓库中「知识产权维权 · 文字冒险」游戏的设计思路、架构与构建实践，以及所遵循的通用规范，便于后续维护与类似项目复用。

---

## 一、项目概述

- **产物**：单页交互式文字冒险游戏（`game/`），基于流程图分支、选项跳转、背包道具收集。
- **技术**：原生 HTML + CSS + JavaScript（ES modules），无构建工具，适合静态托管（如 GitHub Pages）。
- **规范依据**：`.cursor/rules.general.mdc`（项目结构、DRY、单一职责等）、`.cursor/rules.design-principles.mdc`（配置分离、Context、开闭原则等）。

---

## 二、架构分层

整体分为 **配置层、核心层、应用层**，数据与职责边界清晰。

```
┌─────────────────────────────────────────────────────────┐
│  配置层   config/items.js, config/steps.js               │
│          仅静态数据与常量，无业务逻辑                        │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│  核心层   state.js（纯逻辑）, context.js（门面）           │
│          状态结构、变更规则、导航与道具发放                   │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│  应用层   render.js（视图）, events.js（绑定）, app.js（入口）│
│          根据 state + config 渲染，事件调用 context 后 refresh │
└─────────────────────────────────────────────────────────┘
```

- **配置层**：步骤表、道具表、上一步映射、常量（如 `INITIAL_STEP_ID`、`RESTART_ID`、`MAX_STEP_COUNT`）。新增/修改剧情或道具时只改配置，符合开闭原则。
- **核心层**：`state.js` 提供纯函数（`createInitialState`、`addItem`、`reset`、`getProgressPercent`、`isEndStep` 等），不依赖 DOM；`context.js` 持有 config 与 state，对外提供 `getStep`、`getItem`、`getState`、`navigate`、`goBack`，通过 `onToast` 等回调与 UI 解耦。
- **应用层**：`render.js` 只根据入参生成 HTML 或更新 DOM；`events.js` 做事件委托与绑定，调用 context 后执行统一的 `refresh()` 更新全量视图；`app.js` 组装 config、创建 context、定义 refresh、调用 `bind()`。

---

## 三、目录与文件结构

```
game/
  index.html              # 页面骨架，外链 css 与 js，无内联业务
  css/
    main.css              # 全部样式（变量、布局、组件）
  js/
    config/
      items.js            # 道具表 ITEMS
      steps.js            # 步骤表 STEPS、PREV_STEP_MAP、常量
    state.js              # 状态与纯逻辑
    context.js            # GameContext 门面
    render.js             # 步骤/背包/进度条/箭头视图
    events.js             # 事件绑定与委托
    app.js                # 入口：组合并启动
```

- **命名约定**：目录与文件小写 + 下划线（如 `config/`、`steps.js`）；导出函数小写驼峰，常量全大写下划线。
- **资源分类**：样式集中在 `css/`，脚本按职责分在 `config/` 与根级 js，便于定位与测试。

---

## 四、设计原则落地

### 4.1 配置与代码分离

- 步骤、道具、上一步映射、最大步数等全部放在 `config/items.js` 与 `config/steps.js`。
- 业务代码不写死剧情或 id，只从 config 读取；默认值（如 `MAX_STEP_COUNT`）在 config 或 state 中集中定义。

### 4.2 单一职责

| 模块 | 职责 | 不负责 |
|------|------|--------|
| config | 提供静态数据与映射 | 状态、DOM、分支逻辑 |
| state.js | 状态结构与变更、进度与结局判断 | DOM、配置加载、toast |
| context.js | 门面：读配置与状态、导航与道具发放 | 直接操作 DOM |
| render.js | 根据 step/inventory/state 输出视图 | 事件、状态写入 |
| events.js | 绑定事件，调用 context 与 refresh | 业务分支细节 |
| app.js | 组合 config、context、render、events | 具体步骤/道具内容 |

### 4.3 Context 与依赖传递

- 多个模块需要同一批「环境」（配置、当前状态）时，通过 **Context** 统一提供。
- Context 接收 config 与可选回调（如 `onToast`），内部维护 state；事件与渲染只通过 `context.getState()`、`context.getStep(id)`、`context.navigate(nextId)` 等交互，避免多参数穿透和隐式全局变量（迪米特法则）。

### 4.4 DRY 与可测试性

- **渲染**：`renderItemCard(item)`、`renderChoiceButtons(choices, items)` 等小函数复用，步骤与背包共用卡片结构。
- **状态**：`addItem(inventory, itemId)` 返回 `{ newInventory, added }`，不修改原数组；`getProgressPercent(state)` 等为纯函数，便于无 DOM 环境单测。
- **事件**：步骤选项在 `stepContainer` 上做**事件委托**（一个 listener），根据 `data-next`、`data-item` 调用 `context.navigate`，避免为每个按钮单独绑定。

### 4.5 开闭原则

- 新增步骤或结局：只修改 `config/steps.js`（及必要时 `config/items.js`），不修改 `state.js`、`context.js`、`render.js`、`events.js` 的核心逻辑。
- 若未来需要「插件式步骤」，可在此基础上增加步骤注册表，由配置或注册驱动，核心流程保持不变。

---

## 五、构建与实现要点

### 5.1 状态纯函数

- `state.js` 中 `addItem`、`reset`、`getProgressPercent`、`isEndStep` 等均为纯函数，入参和返回值明确，方便单元测试和推理。
- 状态变更集中在 context 内，通过 `navigate`、`goBack` 更新，再通过 `onStateChange` 或事件层调用 `refresh()` 驱动视图更新。

### 5.2 渲染入参驱动

- 所有渲染函数显式接收「当前步骤 / 背包 / 状态」等入参，不直接从全局或 context 读；由 app 或 events 从 context 取数据后传入，便于测试与复用。

### 5.3 事件委托与 refresh

- 步骤内选项按钮通过 `data-next`、`data-item` 标记，在 `stepContainer` 上统一监听 click，减少绑定数量，并在重新渲染步骤后无需重新绑定。
- 任何导致状态变化的操作（选项点击、箭头、键盘）后都调用同一套 `refresh()`，保证进度条、背包、箭头、步骤视图一致更新。

### 5.4 ES modules 与入口

- 使用 `<script type="module" src="js/app.js">` 作为唯一入口，其余模块通过 `import` 链加载；无需打包即可在支持 ES modules 的浏览器中运行。
- 本地调试时需通过 HTTP 服务打开（如 `python3 -m http.server 8765`），避免 `file://` 下模块加载限制。

### 5.5 安全与无障碍

- 动态文案使用 `escapeHtml` 等简单转义，避免 XSS。
- 进度条使用 `aria-valuenow` 等属性，步骤区域使用 `role="main"`、`aria-live="polite"`，便于辅助技术访问。

---

## 六、扩展方式

- **新增/修改步骤**：在 `config/steps.js` 的 `STEPS` 中增改条目（id、title、body、icon、choices、item、isEnd、endType）；若涉及新的「上一步」，在 `PREV_STEP_MAP` 中补全。
- **新增/修改道具**：在 `config/items.js` 的 `ITEMS` 中增改条目（id、name、icon、desc）；步骤的 `item` 或 choices 的 `item` 引用对应 id 即可。
- **调整进度或常量**：修改 `config/steps.js` 中的 `MAX_STEP_COUNT` 等常量；state 与 context 已依赖这些配置，无需改业务代码。

---

## 七、与本仓库规则的对应

- **项目结构规则**（general）：分层组织（config / 核心 / 应用）、命名一致、模块化、资源分类（css / js / config）、约定优先（单入口 app.js）。
- **通用开发原则**：可测试性（纯函数 state、入参驱动 render）、DRY（复用渲染与委托）、单一职责、注释（各模块顶部与关键函数）、设计模式（门面 Context、配置与逻辑分离）。
- **设计原则**（design-principles）：配置与代码分离、Context 传递、单一数据源（状态只在 context 内）、开闭（扩展改 config 不改核心）。

---

## 八、参考文件

- 通用规范：`.cursor/rules.general.mdc`
- 设计原则：`.cursor/rules.design-principles.mdc`
- 游戏入口：`game/index.html`、`game/js/app.js`
- 配置示例：`game/js/config/steps.js`、`game/js/config/items.js`
